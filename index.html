<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comment-field">
         <!--список рендерится из js -->
      </ul>
      <div class="loading"></div>
      <div class="add-form">
        <input 
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя" id="comment-name"
        />
        <textarea 
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий" id="comment-input"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button"  id="comment-button">Написать</button>
        </div>
    </div>
  </body>

  <style>
    .error{
      border: 2px dashed red;
      box-shadow: 0 0 5px 1px red;
    }

  </style>

  <script>
 //создаем переменные 
 const commentField = document.getElementById('comment-field');
 const commentName = document.getElementById('comment-name');
 const commentInput = document.getElementById('comment-input');
 const commentButton = document.getElementById('comment-button');
 const commentLoading = document.querySelector('.loading');
 const date = new Date();

 //создаем данные для HTML разметки //хранение комментов

 let comments = []; //перерасперделяем на let

 function getComment() {
    fetch("https://webdev-hw-api.vercel.app/api/v1/julia/comments",{
      method:"GET"
    })
    .then((response) => {
      return response.json();
      })
    .then((Data) => {
      comments = Data.comments;
      commentLoading.classList.add("display-none");
      commentRender();
    })  
  };
  getComment();
 // Создаем рендер-функцию (преобразование данных в коде в отображение, которое видит пользователь.)
 const commentRender = () => {
  const commentHtml = comments.map((comments, index) => {
      return `<li class="comment" data-index="${index}">
      <div class="comment-header">
        <div>${comments.author.name}</div>
        <div>${comments.date}</div>
      </div>
      <div class="comment-body">
        ${comments.isEdit ? `<textarea id="input" class="comment-text textarea" type="texrarea">${comments.text}</textarea>` : `<div class="comment-text">${comments.text.replaceAll("QUOTE_BEGIN", "<div class='quote'>").replaceAll("QUOTE_END", "</div>")}</div>`}
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">${comments.likes}</span>
          <button class="like-button ${comments.isLike ? '-active-like' : ''}" data-index="${index}"></button>
        </div>
      </div>
      </li>`
  })

  .join('');
  commentField.innerHTML = commentHtml;
  initLikesButton();
  commentReply();
  
 }
 commentRender();

 // ивент на кнопки лайка
 function initLikesButton() {
  const commentLikes = document.querySelectorAll(".like-button");
  for (const buttonLike of commentLikes) {
    const index = buttonLike.dataset.index;
    buttonLike.addEventListener("click", (eventLike) => {
      eventLike.stopPropagation();// кликаем на кнопку лайка и эта функция прерывает дальнейшие всплытия событий 
      if (comments[index].isLike) {
        comments[index].isLike = false;
        comments[index].likes -= 1;
      } else {
        comments[index].isLike = true;
        comments[index].likes += 1;
      }
    commentRender();
    })
  }
 }

 // событие на ответ на коммент пользователя 
 function commentReply () {
  const replayEl = document.querySelectorAll(".comment");
  for (const el of replayEl) {
    const index = el.dataset.index;
    el.addEventListener('click', () => {
      commentInput.value = `» ${comments[index].text} (${comments[index].author.name}) © \n `;
      commentRender();
    })
  }
 }
   // для добавления нового коммента 
   function commentFuncButton()  {
    commentLoading.classList.remove("display-none")
    fetch('https://webdev-hw-api.vercel.app/api/v1/julia/comments', {
    method: "POST",
    body: JSON.stringify({
      name: commentName.value.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;'), 
      // безопасность (производим замену символов) 
      date: `${date.getDate() < 10 ? "0" : ""}${date.getDate()}.${date.getMonth() < 10 ? "0" : ""}${date.getMonth() + 1}.${date.getFullYear() - 2000} 
      ${date.getHours() < 10 ? "0" : ""}${date.getHours()}:${date.getMinutes() < 10 ? "0" : ""}${date.getMinutes()}`,
      text: commentInput.value.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;'),
      likes: 0,
      isLiked: false,
      isEdit: false,
    })
  }).then(() => {
      getComment();
  });// убираем вложенность
  commentName.value = ""; // очищаем поле формы после ввода
  commentInput.value = "";
}
//валидация и событик на кнопку
commentButton.addEventListener("click", () => {
    commentName.classList.remove("error"); // добавляем валидацию если пользователь не ввел имя/коммент 
    if (commentName.value === "") { // 
      commentName.classList.add("error"); // 
      return;
    }
    commentInput.classList.remove("error");
    if (commentInput.value === "") {
      commentInput.classList.add("error");
      return;
    }
    commentFuncButton();
   });

  </script>
</html>
