<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comment-field">
        <li class="comment">
          <div class="comment-header">
            <div>Глеб Фокин</div>
            <div>12.02.22 12:18</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Это будет первый комментарий на этой странице
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">3</span>
              <button class="like-button"></button>
            </div>
          </div>
        </li>
        <li class="comment">
          <div class="comment-header">
            <div>Варвара Н.</div>
            <div>13.02.22 19:22</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Мне нравится как оформлена эта страница! ❤
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">75</span>
              <button class="like-button -active-like"></button>
            </div>
          </div>
        </li>
      </ul>
      <div class="add-form">
        <input 
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя" id="comment-name"
        />
        <textarea 
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий" id="comment-input"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button"  id="comment-button">Написать</button>
        </div>
    </div>
  </body>

  <style>
    .error{
      border: 2px dashed red;
      box-shadow: 0 0 5px 1px red;
    }

  </style>

  <script>
 //создаем переменные 
 const commentField = document.getElementById('comment-field');
 const commentName = document.getElementById('comment-name');
 const commentInput = document.getElementById('comment-input');
 const commentButton = document.getElementById('comment-button');
 const date = new Date();

//  const newDate = new Date();
//  const days = ["Sun", "Mon", "Tues", "Wed", "Thurs", "Fri", "Sat"];
//  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

 //создаем данные для HTML разметки //хранение комментов
  const comments = [];
 const getComment = () => {
    fetch("https://webdev-hw-api.vercel.app/api/v1/julia/comments",{
      method:"GET"
    }).then((response) => {
      response.json().then((Data) => {
        comments = Data.comments;
        commentRender();
      });
    });
  };
 // Создаем рендер-функцию (преобразование данных в коде в отображение, которое видит пользователь.)
 const commentRender = () => {
  const commentHtml = comments.map((comments, index) => {
      return `<li class="comment" data-index="${index}">
      <div class="comment-header">
        <div>${comments.name}</div>
        <div>${comments.date}</div>
      </div>
      <div class="comment-body">
        ${comments.isEdit ? `<textarea id="input" class="comment-text textarea" type="texrarea">${comments.text}</textarea>` : `<div class="comment-text">${comments.text.replaceAll("QUOTE_BEGIN", "<div class='quote'>").replaceAll("QUOTE_END", "</div>")}</div>`}
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">${comments.likesCounter}</span>
          <button class="like-button ${comments.isLike ? '-active-like' : ''}" data-index="${index}"></button>
        </div>
      </div>
      </li>`
  })
  .join('');
  commentField.innerHTML = commentHtml;
  initLikesButton();
  commentReply();
  
 }
 commentRender();

 // ивент на кнопки лайка
 function initLikesButton() {
  const commentLikes = document.querySelectorAll(".like-button");
  for (const buttonLike of commentLikes) {
    const index = buttonLike.dataset.index;
    buttonLike.addEventListener("click", (eventLike) => {
      eventLike.stopPropagation();// кликаем на кнопку лайка и эта функция прерывает дальнейшие всплытия событий 
      if (comments[index].isLike) {
        comments[index].isLike = false;
        comments[index].likesCounter -= 1;
      } else {
        comments[index].isLike = true;
        comments[index].likesCounter += 1;
      }
    commentRender();
    })
  }
 }
 // событие на ответ на коммент пользователя 
 function commentReply () {
  const replayEl = document.querySelectorAll(".comment");
  for (const el of replayEl) {
    const index = el.dataset.index;
    el.addEventListener('click', () => {
      commentInput.value =`QUOTE_BEGIN « ${comments[index].text} » (${comments[index].name}) QUOTE_END \n` ;
      commentRender();
    })
  }
 }
 //добавление обработчиков клика на динамически созданные элементы
//  commentButton.addEventListener("click", () => {
//     commentName.classList.remove("error"); // добавляем валидацию если пользователь не ввел имя/коммент 
//     if (commentName.value === "") { // 
//       commentName.classList.add("error"); // 
//       return;
//     }
//     commentInput.classList.remove("error");
//     if (commentInput.value === "") {
//       commentInput.classList.add("error");
//       return;
//     }
//      commentFuncButton();
//    });
   // для добавления нового коммента 
   function commentFuncButton()  {
    fetch("https://webdev-hw-api.vercel.app/api/v1/julia/comments",{
      method:"POST",
      body : JSON.stringify({
    name: commentName.value.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;'), 
    // Делаем HTML-строку безопасной для рендера, заменяя управляющие символы HTML на спец. символы
    //После добавления комментария введенные теги не должны срабатывать, то есть имя и текст должны отображаться так, как их ввел пользователь
    date: `${date.getDate() < 10 ? "0" : ""}${date.getDate()}.${date.getMonth() < 10 ? "0" : ""}${date.getMonth() + 1}.${date.getFullYear() - 2000} ${date.getHours() < 10 ? "0" : ""}${date.getHours()}:${date.getMinutes() < 10 ? "0" : ""}${date.getMinutes()}`,
    text: commentInput.value.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;'),
    likesCounter: 0,
    isLike: false,
    isEdit: false,
    })
  }).then((response) => {
   response.json().then((data) => {
    getComment();
  });
})
      commentName.value = ""; // очищаем поле формы после ввода
      commentInput.value = "";
}
commentButton.addEventListener("click", () => {
    commentName.classList.remove("error"); // добавляем валидацию если пользователь не ввел имя/коммент 
    if (commentName.value === "") { // 
      commentName.classList.add("error"); // 
      return;
    }
    commentInput.classList.remove("error");
    if (commentInput.value === "") {
      commentInput.classList.add("error");
      return;
    }
    commentFuncButton();
    //  getComment();
   });
 


//  commentRender();
//    commentRender();
//    commentName.value = ""; // очищаем поле формы после ввода
//    commentInput.value = "";
// 
  </script>
</html>
